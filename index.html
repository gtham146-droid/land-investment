<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land Investment Portfolio - Cloud Enabled</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .setup-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            margin: 50px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .setup-container h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
        }

        .setup-steps {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .setup-steps ol {
            margin-left: 20px;
        }

        .setup-steps li {
            margin: 10px 0;
            line-height: 1.6;
        }

        .setup-steps code {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: none;
        }

        .login-container h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard {
            display: none;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #667eea;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sync-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .sync-success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .sync-error {
            background: #ffebee;
            color: #c62828;
        }

        .sync-loading {
            background: #fff3e0;
            color: #f57c00;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn, .sync-btn {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }

        .sync-btn {
            background: #4caf50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .plot-grid {
            display: grid;
            gap: 20px;
        }

        .plot-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .plot-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .plot-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .plot-subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-available { background: #e3f2fd; color: #1976d2; }
        .status-documentation { background: #fff3e0; color: #f57c00; }
        .status-owned { background: #e8f5e9; color: #388e3c; }
        .status-marketing { background: #f3e5f5; color: #7b1fa2; }
        .status-sold { background: #fce4ec; color: #c2185b; }

        .plot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .plot-images {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .plot-image {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e0e0e0;
        }

        .plot-image:hover {
            border-color: #667eea;
        }

        .location-map {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #e0e0e0;
        }

        .investors-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .investor-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .timeline {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .timeline-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .timeline-date {
            font-size: 12px;
            color: #666;
            min-width: 100px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .timeline-desc {
            font-size: 14px;
            color: #666;
        }

        .timeline-amount {
            font-weight: 600;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            margin: 50px auto;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            width: auto;
            padding: 0;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            margin-top: 10px;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 0;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-group button {
            flex: 1;
            min-width: 150px;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #4caf50;
            color: white;
        }

        .error-message {
            background: #f44336;
            color: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .payment-list {
            margin-top: 15px;
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .email-preview {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }

        .email-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .alert-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .plot-details {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-container">
        <h1>üöÄ Google Sheets Setup</h1>
        
        <div class="alert-box">
            <strong>‚ö†Ô∏è First Time Setup Required</strong><br>
            Follow these steps to connect your Google Sheet for data storage.
        </div>

        <div class="setup-steps">
            <h3>Step 1: Create Your Google Sheet</h3>
            <ol>
                <li>Go to <a href="https://sheets.google.com" target="_blank">Google Sheets</a></li>
                <li>Create a new blank spreadsheet</li>
                <li>Name it "Land Investment Data"</li>
                <li>Create two sheets (tabs at bottom):
                    <ul>
                        <li><code>Plots</code> - for plot data</li>
                        <li><code>Payments</code> - for payment transactions</li>
                    </ul>
                </li>
            </ol>

            <h3 style="margin-top: 20px;">Step 2: Set Up Google Apps Script</h3>
            <ol>
                <li>In your spreadsheet, click <strong>Extensions ‚Üí Apps Script</strong></li>
                <li>Delete any existing code</li>
                <li>Copy and paste this code:</li>
            </ol>
            
            <textarea readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 12px; margin: 10px 0;">
function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const action = e.parameter.action;
  
  if (action === 'getPlots') {
    const plotsSheet = sheet.getSheetByName('Plots');
    if (!plotsSheet) return ContentService.createTextOutput(JSON.stringify({error: 'Plots sheet not found'}));
    const data = plotsSheet.getDataRange().getValues();
    return ContentService.createTextOutput(JSON.stringify({plots: data})).setMimeType(ContentService.MimeType.JSON);
  }
  
  if (action === 'getPayments') {
    const paymentsSheet = sheet.getSheetByName('Payments');
    if (!paymentsSheet) return ContentService.createTextOutput(JSON.stringify({error: 'Payments sheet not found'}));
    const data = paymentsSheet.getDataRange().getValues();
    return ContentService.createTextOutput(JSON.stringify({payments: data})).setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}));
}

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const data = JSON.parse(e.postData.contents);
  
  if (data.action === 'savePlots') {
    const plotsSheet = sheet.getSheetByName('Plots');
    plotsSheet.clear();
    plotsSheet.getRange(1, 1, data.plots.length, data.plots[0].length).setValues(data.plots);
    return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
  }
  
  if (data.action === 'savePayments') {
    const paymentsSheet = sheet.getSheetByName('Payments');
    paymentsSheet.clear();
    paymentsSheet.getRange(1, 1, data.payments.length, data.payments[0].length).setValues(data.payments);
    return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}));
}
            </textarea>

            <h3 style="margin-top: 20px;">Step 3: Deploy the Script</h3>
            <ol>
                <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                <li>Click the gear icon ‚öôÔ∏è next to "Select type"</li>
                <li>Choose <strong>Web app</strong></li>
                <li>Set:
                    <ul>
                        <li>Description: "Land Investment API"</li>
                        <li>Execute as: <strong>Me</strong></li>
                        <li>Who has access: <strong>Anyone</strong></li>
                    </ul>
                </li>
                <li>Click <strong>Deploy</strong></li>
                <li>Click <strong>Authorize access</strong> and approve</li>
                <li><strong>Copy the Web app URL</strong> (looks like: https://script.google.com/...)</li>
            </ol>
        </div>

        <div class="form-group" style="margin-top: 30px;">
            <label>Paste Your Web App URL Here:</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/...">
        </div>

        <button onclick="saveApiUrl()">Save & Continue</button>
        
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="skipSetup()" class="btn-secondary">Skip Setup (Use Demo Mode)</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h1>üèûÔ∏è Land Investment Portal</h1>
        <div class="form-group">
            <label>Login As:</label>
            <select id="userSelect">
                <option value="">Select User...</option>
                <option value="admin">Admin (You)</option>
                <option value="investor1">Investor - Rajesh Kumar</option>
                <option value="investor2">Investor - Priya Sharma</option>
                <option value="investor3">Investor - Amit Patel</option>
            </select>
        </div>
        <button onclick="login()">Login</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard container">
        <div class="header">
            <div>
                <h1 id="dashboardTitle">Dashboard</h1>
                <p id="userName" style="color: #666; margin-top: 5px;"></p>
            </div>
            <div class="header-actions">
                <div id="syncStatus" class="sync-status sync-success" style="display: none;">
                    ‚úì Synced
                </div>
                <button class="sync-btn" onclick="syncData()" id="syncButton">
                    üîÑ Sync with Google Sheets
                </button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="successMessage" class="success-message"></div>
        <div id="errorMessage" class="error-message"></div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Tabs -->
        <div class="tabs" id="tabsContainer"></div>

        <!-- Tab Contents -->
        <div id="tabContents"></div>
    </div>

    <!-- Modals (same as previous version) -->
    <div id="addPlotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Plot</h2>
                <button class="close-btn" onclick="closeModal('addPlotModal')">&times;</button>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Plot Name/Location: *</label>
                    <input type="text" id="plotName" placeholder="e.g., Whitefield Plot A-123">
                </div>
                <div class="form-group">
                    <label>Plot Number: *</label>
                    <input type="text" id="plotNumber" placeholder="e.g., A-123">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Survey Number:</label>
                    <input type="text" id="surveyNumber" placeholder="e.g., 45/2B">
                </div>
                <div class="form-group">
                    <label>Document Number:</label>
                    <input type="text" id="documentNumber" placeholder="e.g., REG-2024-1234">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Area (sq ft): *</label>
                    <input type="number" id="plotArea" placeholder="e.g., 2400">
                </div>
                <div class="form-group">
                    <label>Asking Price (‚Çπ): *</label>
                    <input type="number" id="plotPrice" placeholder="e.g., 5000000">
                </div>
            </div>

            <div class="form-group">
                <label>Current Owner:</label>
                <input type="text" id="currentOwner" placeholder="e.g., Mr. Venkatesh Reddy">
            </div>

            <div class="form-group">
                <label>Location Map URL:</label>
                <input type="text" id="locationMap" placeholder="Google Maps embed URL (optional)">
            </div>

            <div class="form-group">
                <label>Photo URLs (comma-separated):</label>
                <input type="text" id="plotPhotos" placeholder="https://example.com/photo1.jpg, https://...">
            </div>

            <div class="form-group">
                <label>Description:</label>
                <textarea id="plotDescription" rows="3" placeholder="Location details, amenities, etc."></textarea>
            </div>

            <button onclick="addPlot()">Add Plot</button>
        </div>
    </div>

    <div id="updatePlotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Plot Status</h2>
                <button class="close-btn" onclick="closeModal('updatePlotModal')">&times;</button>
            </div>
            <input type="hidden" id="updatePlotId">
            
            <div class="form-group">
                <label>Status:</label>
                <select id="updateStatus" onchange="handleStatusChange()">
                    <option value="available">Available for Investment</option>
                    <option value="documentation">Under Documentation</option>
                    <option value="owned">Owned</option>
                    <option value="marketing">Marketing</option>
                    <option value="sold">Sold</option>
                </select>
            </div>

            <div id="ownershipFields" style="display: none;">
                <div class="form-group">
                    <label>Transfer Ownership To:</label>
                    <input type="text" id="newOwner" placeholder="New owner name">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Advance Paid (‚Çπ):</label>
                    <input type="number" id="advancePaid" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>Balance Paid (‚Çπ):</label>
                    <input type="number" id="balancePaid" placeholder="Optional">
                </div>
            </div>

            <div class="form-group">
                <label>Buying Expenses (‚Çπ):</label>
                <input type="number" id="buyingExpenses" placeholder="Broker, docs, registration, etc.">
            </div>

            <div id="sellingFields" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Selling Price (‚Çπ):</label>
                        <input type="number" id="sellingPrice" placeholder="If sold">
                    </div>
                    <div class="form-group">
                        <label>Selling Expenses (‚Çπ):</label>
                        <input type="number" id="sellingExpenses" placeholder="If sold">
                    </div>
                </div>
            </div>

            <button onclick="updatePlot()">Update Plot</button>
            <button class="btn-secondary" onclick="showEmailNotification()">üìß Preview Email</button>
        </div>
    </div>

    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Investor Payment</h2>
                <button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button>
            </div>
            <input type="hidden" id="paymentPlotId">
            
            <div class="form-group">
                <label>Investor:</label>
                <select id="paymentInvestor">
                    <option value="investor1">Rajesh Kumar</option>
                    <option value="investor2">Priya Sharma</option>
                    <option value="investor3">Amit Patel</option>
                </select>
            </div>

            <div class="form-group">
                <label>Payment Amount (‚Çπ):</label>
                <input type="number" id="paymentAmount" placeholder="e.g., 500000">
            </div>

            <div class="form-group">
                <label>Payment Type:</label>
                <select id="paymentType">
                    <option value="investment">Investment (Money In)</option>
                    <option value="return">Return (Money Out)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Date:</label>
                <input type="date" id="paymentDate">
            </div>

            <div class="form-group">
                <label>Notes:</label>
                <input type="text" id="paymentNotes" placeholder="e.g., First installment">
            </div>

            <button onclick="addPayment()">Add Payment</button>
        </div>
    </div>

    <div id="timelineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Transaction Timeline</h2>
                <button class="close-btn" onclick="closeModal('timelineModal')">&times;</button>
            </div>
            <div id="timelineContent"></div>
        </div>
    </div>

    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Email Notification Preview</h2>
                <button class="close-btn" onclick="closeModal('emailModal')">&times;</button>
            </div>
            <div id="emailContent"></div>
            <button onclick="copyEmail()" style="margin-top: 20px;">Copy Email Content</button>
        </div>
    </div>

    <script>
        // Configuration
        let apiUrl = localStorage.getItem('apiUrl') || '';
        let currentUser = null;
        let plots = [];
        let isSyncing = false;

        const users = {
            admin: { name: "Admin", role: "admin" },
            investor1: { name: "Rajesh Kumar", role: "investor", email: "rajesh.kumar@example.com" },
            investor2: { name: "Priya Sharma", role: "investor", email: "priya.sharma@example.com" },
            investor3: { name: "Amit Patel", role: "investor", email: "amit.patel@example.com" }
        };

        // Initialize
        window.onload = function() {
            if (!apiUrl) {
                document.getElementById('setupScreen').style.display = 'block';
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                loadFromLocalStorage();
            }
        };

        function saveApiUrl() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                alert('Please enter your Google Apps Script Web App URL');
                return;
            }
            apiUrl = url;
            localStorage.setItem('apiUrl', url);
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            showSuccess('Setup complete! You can now login and sync data.');
        }

        function skipSetup() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            loadDemoData();
        }

        function loadDemoData() {
            plots = [
                {
                    id: 1,
                    name: "Whitefield Premium Plot",
                    plotNumber: "WF-A-123",
                    surveyNumber: "45/2B",
                    documentNumber: "",
                    area: 2400,
                    price: 5000000,
                    description: "Near IT parks, 30x80 ft, corner plot",
                    currentOwner: "Mr. Venkatesh Reddy",
                    locationMap: "",
                    photos: ["https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400"],
                    status: "available",
                    advancePaid: 0,
                    balancePaid: 0,
                    buyingExpenses: 0,
                    sellingPrice: 0,
                    sellingExpenses: 0,
                    payments: []
                },
                {
                    id: 2,
                    name: "Electronic City Layout",
                    plotNumber: "EC-B-456",
                    surveyNumber: "78/3A",
                    documentNumber: "REG-2024-0156",
                    area: 1800,
                    description: "Gated community, ready for construction",
                    currentOwner: "You (Purchased)",
                    locationMap: "",
                    photos: [],
                    price: 3600000,
                    status: "documentation",
                    advancePaid: 500000,
                    balancePaid: 0,
                    buyingExpenses: 50000,
                    sellingPrice: 0,
                    sellingExpenses: 0,
                    payments: [
                        { 
                            id: 1,
                            investor: "investor1", 
                            amount: 1500000, 
                            type: "investment",
                            date: "2024-01-15",
                            notes: "Investment payment"
                        },
                        {
                            id: 2,
                            investor: "investor2",
                            amount: 1000000,
                            type: "investment",
                            date: "2024-01-15",
                            notes: "Investment payment"
                        }
                    ]
                }
            ];
            saveToLocalStorage();
        }

        // Google Sheets Sync Functions
        async function syncData() {
            if (!apiUrl) {
                showError('Please complete setup first to enable Google Sheets sync');
                return;
            }

            if (isSyncing) return;
            isSyncing = true;
            
            const syncBtn = document.getElementById('syncButton');
            const syncStatus = document.getElementById('syncStatus');
            
            syncBtn.disabled = true;
            syncBtn.textContent = '‚è≥ Syncing...';
            syncStatus.className = 'sync-status sync-loading';
            syncStatus.textContent = '‚è≥ Syncing...';
            syncStatus.style.display = 'block';

            try {
                await saveToGoogleSheets();
                syncStatus.className = 'sync-status sync-success';
                syncStatus.textContent = '‚úì Synced with Google Sheets';
                showSuccess('Data synced successfully with Google Sheets!');
            } catch (error) {
                syncStatus.className = 'sync-status sync-error';
                syncStatus.textContent = '‚úó Sync failed';
                showError('Sync failed: ' + error.message);
            } finally {
                syncBtn.disabled = false;
                syncBtn.textContent = 'üîÑ Sync with Google Sheets';
                isSyncing = false;
                
                setTimeout(() => {
                    if (syncStatus.textContent !== '‚úó Sync failed') {
                        syncStatus.style.display = 'none';
                    }
                }, 3000);
            }
        }

        async function saveToGoogleSheets() {
            // Convert plots to 2D array for Google Sheets
            const plotsData = [
                ['ID', 'Name', 'Plot Number', 'Survey Number', 'Document Number', 'Area', 'Price', 
                 'Description', 'Current Owner', 'Location Map', 'Photos', 'Status', 
                 'Advance Paid', 'Balance Paid', 'Buying Expenses', 'Selling Price', 'Selling Expenses']
            ];

            plots.forEach(plot => {
                plotsData.push([
                    plot.id,
                    plot.name,
                    plot.plotNumber,
                    plot.surveyNumber || '',
                    plot.documentNumber || '',
                    plot.area,
                    plot.price,
                    plot.description || '',
                    plot.currentOwner || '',
                    plot.locationMap || '',
                    (plot.photos || []).join('|'),
                    plot.status,
                    plot.advancePaid || 0,
                    plot.balancePaid || 0,
                    plot.buyingExpenses || 0,
                    plot.sellingPrice || 0,
                    plot.sellingExpenses || 0
                ]);
            });

            // Convert payments to 2D array
            const paymentsData = [
                ['Payment ID', 'Plot ID', 'Investor', 'Amount', 'Type', 'Date', 'Notes']
            ];

            plots.forEach(plot => {
                (plot.payments || []).forEach(payment => {
                    paymentsData.push([
                        payment.id,
                        plot.id,
                        payment.investor,
                        payment.amount,
                        payment.type,
                        payment.date,
                        payment.notes || ''
                    ]);
                });
            });

            // Save plots
            const plotsResponse = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'savePlots',
                    plots: plotsData
                })
            });

            if (!plotsResponse.ok) throw new Error('Failed to save plots');

            // Save payments
            const paymentsResponse = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'savePayments',
                    payments: paymentsData
                })
            });

            if (!paymentsResponse.ok) throw new Error('Failed to save payments');
            
            saveToLocalStorage();
        }

        async function loadFromGoogleSheets() {
            if (!apiUrl) return false;

            try {
                const plotsResponse = await fetch(`${apiUrl}?action=getPlots`);
                const plotsResult = await plotsResponse.json();
                
                const paymentsResponse = await fetch(`${apiUrl}?action=getPayments`);
                const paymentsResult = await paymentsResponse.json();

                if (plotsResult.plots && plotsResult.plots.length > 1) {
                    // Parse plots (skip header row)
                    plots = plotsResult.plots.slice(1).map(row => ({
                        id: row[0],
                        name: row[1],
                        plotNumber: row[2],
                        surveyNumber: row[3],
                        documentNumber: row[4],
                        area: row[5],
                        price: row[6],
                        description: row[7],
                        currentOwner: row[8],
                        locationMap: row[9],
                        photos: row[10] ? row[10].split('|') : [],
                        status: row[11],
                        advancePaid: row[12] || 0,
                        balancePaid: row[13] || 0,
                        buyingExpenses: row[14] || 0,
                        sellingPrice: row[15] || 0,
                        sellingExpenses: row[16] || 0,
                        payments: []
                    }));

                    // Parse payments (skip header row)
                    if (paymentsResult.payments && paymentsResult.payments.length > 1) {
                        paymentsResult.payments.slice(1).forEach(row => {
                            const plotId = row[1];
                            const plot = plots.find(p => p.id === plotId);
                            if (plot) {
                                plot.payments.push({
                                    id: row[0],
                                    investor: row[2],
                                    amount: row[3],
                                    type: row[4],
                                    date: row[5],
                                    notes: row[6]
                                });
                            }
                        });
                    }

                    saveToLocalStorage();
                    return true;
                }
            } catch (error) {
                console.error('Failed to load from Google Sheets:', error);
            }
            
            return false;
        }

        // Local Storage Functions
        function saveToLocalStorage() {
            localStorage.setItem('plotsData', JSON.stringify(plots));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('plotsData');
            if (saved) {
                plots = JSON.parse(saved);
            } else {
                loadDemoData();
            }
        }

        // [Previous app functions continue here - login, logout, renderStats, etc.]
        // Due to length, I'm including key functions:

        function login() {
            const userId = document.getElementById('userSelect').value;
            if (!userId) {
                alert('Please select a user');
                return;
            }
            currentUser = { id: userId, ...users[userId] };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Try to load from Google Sheets first
            if (apiUrl) {
                loadFromGoogleSheets().then(() => {
                    loadDashboard();
                });
            } else {
                loadDashboard();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('userSelect').value = '';
        }

        function loadDashboard() {
            document.getElementById('dashboardTitle').textContent = 
                currentUser.role === 'admin' ? 'Admin Dashboard' : 'My Investment Portfolio';
            document.getElementById('userName').textContent = currentUser.name;

            renderStats();
            renderTabs();
        }

        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            let stats = [];

            if (currentUser.role === 'admin') {
                const totalPlots = plots.length;
                const activePlots = plots.filter(p => p.status !== 'sold').length;
                const totalInvested = plots.reduce((sum, p) => {
                    return sum + (p.payments || []).filter(pay => pay.type === 'investment').reduce((s, i) => s + i.amount, 0);
                }, 0);
                const totalReturned = plots.reduce((sum, p) => {
                    return sum + (p.payments || []).filter(pay => pay.type === 'return').reduce((s, i) => s + i.amount, 0);
                }, 0);

                stats = [
                    { label: 'Total Plots', value: totalPlots },
                    { label: 'Active Plots', value: activePlots },
                    { label: 'Total Investment', value: formatCurrency(totalInvested) },
                    { label: 'Total Returns', value: formatCurrency(totalReturned) }
                ];
            } else {
                const myPlots = plots.filter(p => 
                    (p.payments || []).some(pay => pay.investor === currentUser.id)
                );
                const totalInvested = plots.reduce((sum, p) => {
                    return sum + (p.payments || [])
                        .filter(pay => pay.investor === currentUser.id && pay.type === 'investment')
                        .reduce((s, pay) => s + pay.amount, 0);
                }, 0);
                const totalReturned = plots.reduce((sum, p) => {
                    return sum + (p.payments || [])
                        .filter(pay => pay.investor === currentUser.id && pay.type === 'return')
                        .reduce((s, pay) => s + pay.amount, 0);
                }, 0);
                const activeInvestments = myPlots.filter(p => p.status !== 'sold').length;

                stats = [
                    { label: 'Total Invested', value: formatCurrency(totalInvested) },
                    { label: 'Total Returns', value: formatCurrency(totalReturned) },
                    { label: 'Active Investments', value: activeInvestments },
                    { label: 'Profit/Loss', value: formatCurrency(totalReturned - totalInvested) }
                ];
            }

            statsGrid.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <h3>${s.label}</h3>
                    <div class="value">${s.value}</div>
                </div>
            `).join('');
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            const tabContents = document.getElementById('tabContents');

            if (currentUser.role === 'admin') {
                tabsContainer.innerHTML = `
                    <button class="tab active" onclick="switchTab('all')">All Plots</button>
                    <button class="tab" onclick="switchTab('available')">Available</button>
                    <button class="tab" onclick="switchTab('active')">Active</button>
                    <button class="tab" onclick="switchTab('sold')">Sold</button>
                `;

                tabContents.innerHTML = `
                    <div id="tab-all" class="tab-content active">
                        <button onclick="openModal('addPlotModal')" style="margin-bottom: 20px;">+ Add New Plot</button>
                        <div id="allPlots" class="plot-grid"></div>
                    </div>
                    <div id="tab-available" class="tab-content">
                        <div id="availablePlots" class="plot-grid"></div>
                    </div>
                    <div id="tab-active" class="tab-content">
                        <div id="activePlots" class="plot-grid"></div>
                    </div>
                    <div id="tab-sold" class="tab-content">
                        <div id="soldPlots" class="plot-grid"></div>
                    </div>
                `;

                renderAdminPlots();
            } else {
                tabsContainer.innerHTML = `
                    <button class="tab active" onclick="switchTab('my-investments')">My Investments</button>
                    <button class="tab" onclick="switchTab('opportunities')">Opportunities</button>
                    <button class="tab" onclick="switchTab('my-timeline')">My Timeline</button>
                `;

                tabContents.innerHTML = `
                    <div id="tab-my-investments" class="tab-content active">
                        <div id="myInvestments" class="plot-grid"></div>
                    </div>
                    <div id="tab-opportunities" class="tab-content">
                        <div id="opportunities" class="plot-grid"></div>
                    </div>
                    <div id="tab-my-timeline" class="tab-content">
                        <div id="myTimeline"></div>
                    </div>
                `;

                renderInvestorPlots();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'my-timeline' && currentUser.role === 'investor') {
                renderInvestorTimeline();
            }
        }

        // Simplified render functions (keeping core logic)
        function renderAdminPlots() {
            document.getElementById('allPlots').innerHTML = plots.map(p => renderPlotCard(p, true)).join('') || '<div class="plot-card">No plots yet. Click "Add New Plot" to get started!</div>';
            document.getElementById('availablePlots').innerHTML = 
                plots.filter(p => p.status === 'available').map(p => renderPlotCard(p, true)).join('') || '<div class="plot-card">No available plots</div>';
            document.getElementById('activePlots').innerHTML = 
                plots.filter(p => p.status !== 'available' && p.status !== 'sold').map(p => renderPlotCard(p, true)).join('') || '<div class="plot-card">No active plots</div>';
            document.getElementById('soldPlots').innerHTML = 
                plots.filter(p => p.status === 'sold').map(p => renderPlotCard(p, true)).join('') || '<div class="plot-card">No sold plots</div>';
        }

        function renderInvestorPlots() {
            const myPlots = plots.filter(p => (p.payments || []).some(pay => pay.investor === currentUser.id));
            const opportunities = plots.filter(p => p.status === 'available');

            document.getElementById('myInvestments').innerHTML = 
                myPlots.length ? myPlots.map(p => renderPlotCard(p, false)).join('') : 
                '<div class="plot-card">No investments yet. Check opportunities tab!</div>';

            document.getElementById('opportunities').innerHTML = 
                opportunities.length ? opportunities.map(p => renderPlotCard(p, false)).join('') : 
                '<div class="plot-card">No opportunities available</div>';
        }

        function renderInvestorTimeline() {
            const myPayments = [];
            plots.forEach(plot => {
                (plot.payments || []).forEach(payment => {
                    if (payment.investor === currentUser.id) {
                        myPayments.push({
                            ...payment,
                            plotName: plot.name,
                            plotNumber: plot.plotNumber
                        });
                    }
                });
            });

            myPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

            const timelineHTML = `
                <div class="timeline">
                    <h3 style="margin-bottom: 20px;">All Your Transactions</h3>
                    ${myPayments.map(payment => `
                        <div class="timeline-item">
                            <div class="timeline-date">${formatDate(payment.date)}</div>
                            <div class="timeline-content">
                                <div class="timeline-title">
                                    ${payment.type === 'investment' ? 'üí∞ Investment' : '‚úÖ Return Received'}
                                </div>
                                <div class="timeline-desc">
                                    ${payment.plotName} (${payment.plotNumber})<br>
                                    ${payment.notes}
                                </div>
                                <div class="timeline-amount">
                                    ${payment.type === 'investment' ? '-' : '+'} ${formatCurrency(payment.amount)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    ${myPayments.length === 0 ? '<p style="text-align: center; color: #666;">No transactions yet</p>' : ''}
                </div>
            `;

            document.getElementById('myTimeline').innerHTML = timelineHTML;
        }

        function renderPlotCard(plot, isAdmin) {
            const statusClass = `status-${plot.status}`;
            const statusText = {
                available: 'üîç Available',
                documentation: 'üìù Documentation',
                owned: '‚úÖ Owned',
                marketing: 'üí∞ Marketing',
                sold: 'üéâ Sold'
            }[plot.status];

            const payments = plot.payments || [];
            const totalInvestment = payments.filter(p => p.type === 'investment').reduce((sum, p) => sum + p.amount, 0);
            const myPayments = payments.filter(p => p.investor === currentUser.id);
            const myTotalInvestment = myPayments.filter(p => p.type === 'investment').reduce((sum, p) => sum + p.amount, 0);
            const myStake = totalInvestment > 0 ? ((myTotalInvestment / totalInvestment) * 100).toFixed(1) : 0;

            let detailsHTML = `
                <div class="plot-details">
                    <div class="detail-item">
                        <div class="detail-label">Plot Number</div>
                        <div class="detail-value">${plot.plotNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Area</div>
                        <div class="detail-value">${plot.area} sq ft</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Price</div>
                        <div class="detail-value">${formatCurrency(plot.price)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Owner</div>
                        <div class="detail-value" style="font-size: 13px;">${plot.currentOwner}</div>
                    </div>
                </div>
            `;

            if (plot.description) {
                detailsHTML += `<p style="margin: 15px 0; color: #666;">${plot.description}</p>`;
            }

            if (!isAdmin && myTotalInvestment > 0) {
                detailsHTML += `
                    <div style="margin-top: 15px; padding: 15px; background: #f0f7ff; border-radius: 8px;">
                        <strong>My Investment: ${formatCurrency(myTotalInvestment)} (${myStake}% stake)</strong>
                    </div>
                `;
            }

            let actionsHTML = '';
            if (isAdmin) {
                actionsHTML = `
                    <div class="btn-group" style="margin-top: 15px;">
                        <button onclick="openUpdatePlot(${plot.id})">Update Status</button>
                        <button onclick="openAddPayment(${plot.id})" class="btn-secondary">Add Payment</button>
                    </div>
                `;
            }

            return `
                <div class="plot-card">
                    <div class="plot-header">
                        <div>
                            <div class="plot-title">${plot.name}</div>
                            <div class="plot-subtitle">${plot.plotNumber}</div>
                        </div>
                        <div class="status-badge ${statusClass}">${statusText}</div>
                    </div>
                    ${detailsHTML}
                    ${actionsHTML}
                </div>
            `;
        }

        function formatCurrency(amount) {
            return '‚Çπ' + (amount || 0).toLocaleString('en-IN');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'addPaymentModal') {
                document.getElementById('paymentDate').valueAsDate = new Date();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function addPlot() {
            const name = document.getElementById('plotName').value;
            const plotNumber = document.getElementById('plotNumber').value;
            const area = parseInt(document.getElementById('plotArea').value);
            const price = parseInt(document.getElementById('plotPrice').value);

            if (!name || !plotNumber || !area || !price) {
                alert('Please fill all required fields');
                return;
            }

            const newPlot = {
                id: plots.length + 1,
                name,
                plotNumber,
                surveyNumber: document.getElementById('surveyNumber').value,
                documentNumber: document.getElementById('documentNumber').value,
                area,
                price,
                description: document.getElementById('plotDescription').value,
                currentOwner: document.getElementById('currentOwner').value || 'Available',
                locationMap: document.getElementById('locationMap').value,
                photos: document.getElementById('plotPhotos').value.split(',').map(p => p.trim()).filter(p => p),
                status: 'available',
                advancePaid: 0,
                balancePaid: 0,
                buyingExpenses: 0,
                sellingPrice: 0,
                sellingExpenses: 0,
                payments: []
            };

            plots.push(newPlot);
            saveToLocalStorage();
            closeModal('addPlotModal');
            showSuccess('Plot added! Remember to sync with Google Sheets.');
            loadDashboard();

            // Clear form
            ['plotName', 'plotNumber', 'surveyNumber', 'documentNumber', 'plotArea', 
             'plotPrice', 'plotDescription', 'currentOwner', 'locationMap', 'plotPhotos'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        function openUpdatePlot(plotId) {
            const plot = plots.find(p => p.id === plotId);
            document.getElementById('updatePlotId').value = plotId;
            document.getElementById('updateStatus').value = plot.status;
            document.getElementById('advancePaid').value = plot.advancePaid || '';
            document.getElementById('balancePaid').value = plot.balancePaid || '';
            document.getElementById('buyingExpenses').value = plot.buyingExpenses || '';
            document.getElementById('sellingPrice').value = plot.sellingPrice || '';
            document.getElementById('sellingExpenses').value = plot.sellingExpenses || '';
            handleStatusChange();
            openModal('updatePlotModal');
        }

        function handleStatusChange() {
            const status = document.getElementById('updateStatus').value;
            document.getElementById('ownershipFields').style.display = 
                (status === 'owned' || status === 'sold') ? 'block' : 'none';
            document.getElementById('sellingFields').style.display = 
                (status === 'sold') ? 'block' : 'none';
        }

        function updatePlot() {
            const plotId = parseInt(document.getElementById('updatePlotId').value);
            const plot = plots.find(p => p.id === plotId);

            plot.status = document.getElementById('updateStatus').value;
            plot.advancePaid = parseInt(document.getElementById('advancePaid').value) || 0;
            plot.balancePaid = parseInt(document.getElementById('balancePaid').value) || 0;
            plot.buyingExpenses = parseInt(document.getElementById('buyingExpenses').value) || 0;
            plot.sellingPrice = parseInt(document.getElementById('sellingPrice').value) || 0;
            plot.sellingExpenses = parseInt(document.getElementById('sellingExpenses').value) || 0;

            const newOwner = document.getElementById('newOwner').value;
            if (newOwner && (plot.status === 'owned' || plot.status === 'sold')) {
                plot.currentOwner = newOwner;
            } else if (plot.status === 'owned' && !newOwner) {
                plot.currentOwner = 'You (Purchased)';
            }

            // Auto-calculate returns if sold
            if (plot.status === 'sold' && plot.sellingPrice > 0) {
                const totalCost = plot.price + plot.buyingExpenses;
                const profit = plot.sellingPrice - totalCost - plot.sellingExpenses;
                const totalInvestment = (plot.payments || [])
                    .filter(p => p.type === 'investment')
                    .reduce((sum, p) => sum + p.amount, 0);

                const investorTotals = {};
                (plot.payments || []).forEach(payment => {
                    if (payment.type === 'investment') {
                        investorTotals[payment.investor] = (investorTotals[payment.investor] || 0) + payment.amount;
                    }
                });

                Object.entries(investorTotals).forEach(([investor, invested]) => {
                    const stake = invested / totalInvestment;
                    const returnAmount = invested + (profit * stake);
                    
                    const existingReturn = (plot.payments || []).find(
                        p => p.investor === investor && p.type === 'return'
                    );
                    
                    if (!existingReturn) {
                        if (!plot.payments) plot.payments = [];
                        plot.payments.push({
                            id: Date.now() + Math.random(),
                            investor: investor,
                            amount: returnAmount,
                            type: 'return',
                            date: new Date().toISOString().split('T')[0],
                            notes: 'Profit distributed after sale'
                        });
                    }
                });
            }

            saveToLocalStorage();
            closeModal('updatePlotModal');
            showSuccess('Plot updated! Remember to sync with Google Sheets.');
            loadDashboard();
        }

        function openAddPayment(plotId) {
            document.getElementById('paymentPlotId').value = plotId;
            openModal('addPaymentModal');
        }

        function addPayment() {
            const plotId = parseInt(document.getElementById('paymentPlotId').value);
            const plot = plots.find(p => p.id === plotId);
            const amount = parseInt(document.getElementById('paymentAmount').value);

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (!plot.payments) plot.payments = [];
            
            plot.payments.push({
                id: Date.now(),
                investor: document.getElementById('paymentInvestor').value,
                amount: amount,
                type: document.getElementById('paymentType').value,
                date: document.getElementById('paymentDate').value,
                notes: document.getElementById('paymentNotes').value || 'Payment'
            });

            saveToLocalStorage();
            closeModal('addPaymentModal');
            showSuccess('Payment added! Remember to sync with Google Sheets.');
            loadDashboard();

            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';
        }

        function showEmailNotification() {
            alert('Email preview feature - copy your plot details and send to investors!');
        }

        function copyEmail() {
            alert('Email copied to clipboard!');
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>