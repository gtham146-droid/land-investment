<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land Investment Portfolio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --sidebar-bg: #ffffff;
            --main-bg: #f8f9fa;
            --primary: #10b981;
            --primary-light: #d1fae5;
            --secondary: #6366f1;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --card-bg: #ffffff;
            --hover: #f3f4f6;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--main-bg);
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            display: none;
        }
        
        .sidebar.active { display: block; }
        
        .logo {
            padding: 0 20px;
            margin-bottom: 32px;
        }
        
        .logo h2 {
            font-size: 18px;
            color: var(--text-dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .nav-item:hover {
            background: var(--hover);
            color: var(--text-dark);
        }
        
        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 20px;
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            padding: 24px;
            transition: margin-left 0.3s;
        }
        
        .main-content.shifted {
            margin-left: 260px;
        }
        
        /* Top Bar */
        .topbar {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .topbar h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: var(--hover);
            color: var(--text-dark);
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-icon {
            padding: 8px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: var(--hover);
            border-color: var(--text-light);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        /* Content Card */
        .content-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--main-bg);
            border-radius: 8px;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
            font-size: 14px;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        tbody tr:hover {
            background: var(--hover);
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-available { background: #dbeafe; color: #1e40af; }
        .status-documentation { background: #fef3c7; color: #92400e; }
        .status-owned { background: #d1fae5; color: #065f46; }
        .status-marketing { background: #e9d5ff; color: #6b21a8; }
        .status-sold { background: #fce7f3; color: #9f1239; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            margin: 40px auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .close-btn:hover {
            background: var(--hover);
            color: var(--text-dark);
        }
        
        /* Form */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Login */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        
        .login-card h1 {
            text-align: center;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 24px;
        }
        
        .login-card p {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 32px;
            font-size: 14px;
        }
        
        .setup-link {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
        }
        
        .setup-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .setup-link a:hover {
            text-decoration: underline;
        }
        
        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }
        
        .message-success {
            background: var(--primary-light);
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; }
            .main-content { margin-left: 0 !important; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <h1>üèûÔ∏è Land Investment</h1>
            <p>Welcome back! Please login to continue</p>
            
            <div id="loginError" class="message message-error" style="margin-bottom: 16px;"></div>
            
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="loginUsername" class="form-input" placeholder="Enter username" autocomplete="username">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" autocomplete="current-password">
            </div>
            
            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-top: 8px;">
                Login ‚Üí
            </button>
            
            <div class="setup-link">
                <a href="#" onclick="resetSetup(); return false;">‚öôÔ∏è Change Google Sheets Settings</a>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <h2>üèûÔ∏è LandInvest</h2>
        </div>
        
        <div id="sidebarNav"></div>
        
        <div style="position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 20px;">
            <button class="nav-item" onclick="changeAdminPassword()" id="changePasswordBtn" style="display: none; margin-bottom: 8px;">
                <span class="nav-icon">üîë</span>
                Change Password
            </button>
            <button class="nav-item" onclick="logout()" style="color: var(--danger);">
                <span class="nav-icon">üö™</span>
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="topbar">
            <div>
                <h1 id="pageTitle">Dashboard</h1>
                <p style="color: var(--text-light); font-size: 14px; margin-top: 4px;" id="pageSubtitle"></p>
            </div>
            <div class="topbar-actions">
                <div id="syncStatus" class="message" style="margin: 0; padding: 6px 12px; font-size: 12px;"></div>
                <button class="btn btn-secondary" onclick="syncData()" id="syncBtn">
                    üîÑ Sync
                </button>
            </div>
        </div>

        <div id="successMessage" class="message message-success"></div>
        <div id="errorMessage" class="message message-error"></div>

        <div class="stats-grid" id="statsGrid"></div>
        
        <div id="mainContentArea"></div>
    </div>

    <!-- Plot Modal -->
    <div id="plotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="plotModalTitle">Add New Plot</h2>
                <button class="close-btn" onclick="closeModal('plotModal')">&times;</button>
            </div>
            <input type="hidden" id="editPlotId">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Plot Name *</label>
                    <input type="text" id="plotName" class="form-input" placeholder="Whitefield Premium">
                </div>
                <div class="form-group">
                    <label class="form-label">Plot Number *</label>
                    <input type="text" id="plotNumber" class="form-input" placeholder="WF-A-123">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Survey Number</label>
                    <input type="text" id="surveyNumber" class="form-input" placeholder="45/2B">
                </div>
                <div class="form-group">
                    <label class="form-label">Area (sq ft) *</label>
                    <input type="number" id="plotArea" class="form-input" placeholder="2400">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Price (‚Çπ) *</label>
                    <input type="number" id="plotPrice" class="form-input" placeholder="5000000">
                </div>
                <div class="form-group">
                    <label class="form-label">Current Owner</label>
                    <input type="text" id="currentOwner" class="form-input" placeholder="Owner name">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="plotStatus" class="form-select">
                        <option value="available">Available</option>
                        <option value="documentation">Documentation</option>
                        <option value="owned">Owned</option>
                        <option value="marketing">Marketing</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Advance Paid (‚Çπ)</label>
                    <input type="number" id="advancePaid" class="form-input" placeholder="0">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="plotDescription" class="form-textarea" rows="3" placeholder="Location details..."></textarea>
            </div>

            <button onclick="savePlot()" class="btn btn-primary" style="width: 100%;">
                Save Plot
            </button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="paymentModalTitle">Add Payment</h2>
                <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
            </div>
            <input type="hidden" id="editPaymentId">
            <input type="hidden" id="paymentPlotId">
            
            <div style="background: var(--primary-light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <div id="plotInfo" style="font-size: 14px; font-weight: 600; color: var(--text-dark);"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Investor</label>
                <select id="paymentInvestor" class="form-select">
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Amount (‚Çπ) *</label>
                    <input type="number" id="paymentAmount" class="form-input" placeholder="500000">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select id="paymentType" class="form-select">
                        <option value="investment">Investment</option>
                        <option value="return">Return</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" id="paymentDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <input type="text" id="paymentNotes" class="form-input" placeholder="First installment">
                </div>
            </div>

            <button onclick="savePayment()" class="btn btn-primary" style="width: 100%;">
                Save Payment
            </button>
        </div>
    </div>

    <!-- Investor Modal -->
    <div id="investorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="investorModalTitle">Add Investor</h2>
                <button class="close-btn" onclick="closeModal('investorModal')">&times;</button>
            </div>
            <input type="hidden" id="editInvestorId">
            
            <div class="form-group">
                <label class="form-label">Full Name *</label>
                <input type="text" id="investorName" class="form-input" placeholder="e.g., Rajesh Kumar">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Username * (for login)</label>
                    <input type="text" id="investorUsername" class="form-input" placeholder="e.g., rajesh" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="text" id="investorPassword" class="form-input" placeholder="e.g., raj123" autocomplete="new-password">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Email (optional)</label>
                <input type="email" id="investorEmail" class="form-input" placeholder="e.g., rajesh@example.com">
            </div>

            <button onclick="saveInvestor()" class="btn btn-primary" style="width: 100%;">
                Save Investor
            </button>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Change Admin Password</h2>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Current Password *</label>
                <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
            </div>

            <div class="form-group">
                <label class="form-label">New Password *</label>
                <input type="password" id="newPassword" class="form-input" placeholder="Enter new password">
            </div>

            <div class="form-group">
                <label class="form-label">Confirm New Password *</label>
                <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password">
            </div>

            <button onclick="saveNewPassword()" class="btn btn-primary" style="width: 100%;">
                Update Password
            </button>
        </div>
    </div>

    <script>
        let apiUrl = localStorage.getItem('apiUrl') || '';
        let setupCompleted = localStorage.getItem('setupCompleted') === 'true';
        let currentUser = null;
        let currentView = 'plots';
        let plots = [];

        const users = {};
        let investors = [
            { id: 'admin', name: 'Admin', username: 'admin', password: 'admin123', role: 'admin', email: '' },
            { id: 'investor1', name: 'Rajesh Kumar', username: 'rajesh', password: 'raj123', role: 'investor', email: 'rajesh.kumar@example.com' },
            { id: 'investor2', name: 'Priya Sharma', username: 'priya', password: 'priya123', role: 'investor', email: 'priya.sharma@example.com' },
            { id: 'investor3', name: 'Amit Patel', username: 'amit', password: 'amit123', role: 'investor', email: 'amit.patel@example.com' }
        ];

        // Build users object from investors array
        function buildUsersObject() {
            investors.forEach(inv => {
                users[inv.id] = inv;
            });
        }

        buildUsersObject();

        window.onload = function() {
            if (!setupCompleted) {
                // Show setup in a modal instead
                if (!apiUrl) {
                    const setup = prompt('Enter your Google Apps Script Web App URL (or leave empty for demo mode):');
                    if (setup) {
                        apiUrl = setup;
                        localStorage.setItem('apiUrl', setup);
                    }
                    localStorage.setItem('setupCompleted', 'true');
                    setupCompleted = true;
                }
            }
            loadFromLocalStorage();
            loadInvestorsFromLocalStorage();
        };

        function resetSetup() {
            if (confirm('Clear Google Sheets settings?')) {
                localStorage.removeItem('setupCompleted');
                localStorage.removeItem('apiUrl');
                location.reload();
            }
        }

        function loadDemoData() {
            plots = [
                {
                    id: 1, name: "Whitefield Premium", plotNumber: "WF-A-123",
                    surveyNumber: "45/2B", area: 2400, price: 5000000,
                    description: "Near IT parks, corner plot", currentOwner: "Mr. Venkatesh",
                    status: "available", advancePaid: 0, payments: []
                },
                {
                    id: 2, name: "Electronic City Layout", plotNumber: "EC-B-456",
                    area: 1800, price: 3600000, description: "Gated community",
                    currentOwner: "You (Purchased)", status: "documentation", advancePaid: 500000,
                    payments: [
                        { id: 1, investor: "investor1", amount: 1500000, type: "investment", date: "2024-01-15", notes: "Investment" },
                        { id: 2, investor: "investor2", amount: 1000000, type: "investment", date: "2024-01-15", notes: "Investment" }
                    ]
                }
            ];
            saveToLocalStorage();
        }

        function syncData() {
            if (!apiUrl) {
                showError('Google Sheets not configured. Using local storage only.');
                return;
            }

            const syncBtn = document.getElementById('syncBtn');
            const syncStatus = document.getElementById('syncStatus');
            
            syncBtn.disabled = true;
            syncBtn.textContent = '‚è≥ Syncing...';
            syncStatus.className = 'message message-success';
            syncStatus.textContent = 'Syncing...';
            syncStatus.style.display = 'block';

            saveToGoogleSheets()
                .then(() => {
                    syncStatus.textContent = '‚úì Synced!';
                    showSuccess('Synced with Google Sheets!');
                })
                .catch(error => {
                    syncStatus.className = 'message message-error';
                    syncStatus.textContent = '‚úó Failed';
                    showError('Sync failed: ' + error.message);
                })
                .finally(() => {
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'üîÑ Sync';
                    setTimeout(() => syncStatus.style.display = 'none', 3000);
                });
        }

        function saveToGoogleSheets() {
            return new Promise((resolve, reject) => {
                const plotsData = [['ID', 'Name', 'Plot Number', 'Survey Number', 'Area', 'Price', 'Description', 'Current Owner', 'Status', 'Advance Paid']];
                plots.forEach(plot => {
                    plotsData.push([plot.id, plot.name, plot.plotNumber, plot.surveyNumber || '', plot.area, plot.price, 
                        plot.description || '', plot.currentOwner || '', plot.status, plot.advancePaid || 0]);
                });

                const paymentsData = [['Payment ID', 'Plot ID', 'Investor', 'Amount', 'Type', 'Date', 'Notes']];
                plots.forEach(plot => {
                    (plot.payments || []).forEach(payment => {
                        paymentsData.push([payment.id, plot.id, payment.investor, payment.amount, payment.type, payment.date, payment.notes || '']);
                    });
                });

                const investorsData = [['ID', 'Name', 'Username', 'Password', 'Role', 'Email']];
                investors.forEach(inv => {
                    investorsData.push([inv.id, inv.name, inv.username, inv.password, inv.role, inv.email || '']);
                });

                const dataToSend = { plots: plotsData, payments: paymentsData, investors: investorsData };
                const jsonString = JSON.stringify(dataToSend);
                const encoded = btoa(unescape(encodeURIComponent(jsonString)));

                window.saveCallback = function(response) {
                    if (response.success) {
                        saveToLocalStorage();
                        saveInvestorsToLocalStorage();
                        resolve();
                    } else {
                        reject(new Error(response.error || 'Unknown error'));
                    }
                    delete window.saveCallback;
                };

                const script = document.createElement('script');
                script.src = `${apiUrl}?action=saveData&data=${encodeURIComponent(encoded)}&callback=saveCallback`;
                script.onerror = () => { delete window.saveCallback; reject(new Error('Network error')); };
                document.body.appendChild(script);
                setTimeout(() => { if (script.parentNode) script.parentNode.removeChild(script); }, 10000);
            });
        }

        function loadFromGoogleSheets() {
            if (!apiUrl) return Promise.resolve(false);
            return new Promise((resolve) => {
                window.loadCallback = function(data) {
                    if (data.success && data.plots && data.plots.length > 1) {
                        plots = data.plots.slice(1).map(row => ({
                            id: row[0], name: row[1], plotNumber: row[2], surveyNumber: row[3],
                            area: row[4], price: row[5], description: row[6], currentOwner: row[7],
                            status: row[8], advancePaid: row[9] || 0, payments: []
                        }));
                        if (data.payments && data.payments.length > 1) {
                            data.payments.slice(1).forEach(row => {
                                const plot = plots.find(p => p.id === row[1]);
                                if (plot) {
                                    plot.payments.push({ id: row[0], investor: row[2], amount: row[3], type: row[4], date: row[5], notes: row[6] });
                                }
                            });
                        }
                        if (data.investors && data.investors.length > 1) {
                            investors = data.investors.slice(1).map(row => ({
                                id: row[0], name: row[1], username: row[2], password: row[3], role: row[4], email: row[5] || ''
                            }));
                            buildUsersObject();
                        }
                        saveToLocalStorage();
                        saveInvestorsToLocalStorage();
                        resolve(true);
                    } else { resolve(false); }
                    delete window.loadCallback;
                };
                const script = document.createElement('script');
                script.src = `${apiUrl}?action=getData&callback=loadCallback`;
                script.onerror = () => { delete window.loadCallback; resolve(false); };
                document.body.appendChild(script);
            });
        }

        function saveToLocalStorage() {
            localStorage.setItem('plotsData', JSON.stringify(plots));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('plotsData');
            if (saved) {
                plots = JSON.parse(saved);
            } else {
                loadDemoData();
            }
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            if (!username || !password) {
                errorEl.textContent = 'Please enter username and password';
                errorEl.style.display = 'block';
                return;
            }
            
            // Find user by username and password
            const user = investors.find(inv => inv.username === username && inv.password === password);
            
            if (!user) {
                errorEl.textContent = 'Invalid username or password';
                errorEl.style.display = 'block';
                return;
            }
            
            currentUser = { id: user.id, ...user };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('mainContent').classList.add('shifted');
            
            if (apiUrl) {
                loadFromGoogleSheets().then(() => loadDashboard());
            } else {
                loadDashboard();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('mainContent').classList.remove('shifted');
        }

        function loadDashboard() {
            renderSidebar();
            renderStats();
            switchView('plots');
            
            // Show change password button for admin
            if (currentUser.role === 'admin') {
                document.getElementById('changePasswordBtn').style.display = 'flex';
            }
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebarNav');
            if (currentUser.role === 'admin') {
                nav.innerHTML = `
                    <button class="nav-item active" onclick="switchView('plots')">
                        <span class="nav-icon">üìä</span> Plots
                    </button>
                    <button class="nav-item" onclick="switchView('payments')">
                        <span class="nav-icon">üí∞</span> Payments
                    </button>
                    <button class="nav-item" onclick="switchView('investors')">
                        <span class="nav-icon">üë•</span> Investors
                    </button>
                `;
            } else {
                nav.innerHTML = `
                    <button class="nav-item active" onclick="switchView('my-plots')">
                        <span class="nav-icon">üìä</span> My Investments
                    </button>
                    <button class="nav-item" onclick="switchView('opportunities')">
                        <span class="nav-icon">üîç</span> Opportunities
                    </button>
                `;
            }
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            const titles = {
                'plots': 'All Plots',
                'payments': 'All Payments',
                'investors': 'Investor Management',
                'my-plots': 'My Investments',
                'opportunities': 'Investment Opportunities'
            };
            
            document.getElementById('pageTitle').textContent = titles[view];
            document.getElementById('pageSubtitle').textContent = currentUser.name;
            
            if (view === 'plots') renderPlotsView();
            else if (view === 'payments') renderPaymentsView();
            else if (view === 'investors') renderInvestorsView();
            else if (view === 'my-plots') renderMyPlotsView();
            else if (view === 'opportunities') renderOpportunitiesView();
        }

        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            let stats = [];

            if (currentUser.role === 'admin') {
                const totalInvested = plots.reduce((sum, p) => 
                    sum + (p.payments || []).filter(pay => pay.type === 'investment').reduce((s, i) => s + i.amount, 0), 0);
                const totalReturns = plots.reduce((sum, p) => 
                    sum + (p.payments || []).filter(pay => pay.type === 'return').reduce((s, i) => s + i.amount, 0), 0);
                stats = [
                    { label: 'Total Plots', value: plots.length },
                    { label: 'Active Plots', value: plots.filter(p => p.status !== 'sold').length },
                    { label: 'Total Investment', value: formatCurrency(totalInvested) },
                    { label: 'Total Returns', value: formatCurrency(totalReturns) }
                ];
            } else {
                const myPlots = plots.filter(p => (p.payments || []).some(pay => pay.investor === currentUser.id));
                const totalInvested = plots.reduce((sum, p) => 
                    sum + (p.payments || [])
                        .filter(pay => pay.investor === currentUser.id && pay.type === 'investment')
                        .reduce((s, pay) => s + pay.amount, 0), 0);
                const totalReturns = plots.reduce((sum, p) => 
                    sum + (p.payments || [])
                        .filter(pay => pay.investor === currentUser.id && pay.type === 'return')
                        .reduce((s, pay) => s + pay.amount, 0), 0);
                const profitLoss = totalReturns - totalInvested;
                const activePlots = myPlots.filter(p => p.status !== 'sold').length;
                
                stats = [
                    { label: 'Total Invested', value: formatCurrency(totalInvested) },
                    { label: 'Total Returns', value: formatCurrency(totalReturns) },
                    { label: 'Profit/Loss', value: formatCurrency(profitLoss), color: profitLoss >= 0 ? '#10b981' : '#ef4444' },
                    { label: 'Active Plots', value: activePlots }
                ];
            }

            statsGrid.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <div class="stat-label">${s.label}</div>
                    <div class="stat-value" style="${s.color ? 'color: ' + s.color : ''}">${s.value}</div>
                </div>
            `).join('');
        }

        function renderPlotsView() {
            const content = document.getElementById('mainContentArea');
            content.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">All Plots</h3>
                        <button class="btn btn-primary" onclick="openAddPlot()">+ Add Plot</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Plot #</th>
                                <th>Name</th>
                                <th>Area</th>
                                <th>Price</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plotsTableBody"></tbody>
                    </table>
                </div>
            `;
            renderPlotsTable();
        }

        function renderPlotsTable() {
            const tbody = document.getElementById('plotsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = plots.map(plot => {
                const statusClass = `status-${plot.status}`;
                const statusText = { available: 'Available', documentation: 'Documentation', owned: 'Owned', marketing: 'Marketing', sold: 'Sold' }[plot.status];
                return `
                    <tr>
                        <td><strong>${plot.plotNumber}</strong></td>
                        <td>${plot.name}</td>
                        <td>${plot.area.toLocaleString()} sq ft</td>
                        <td>${formatCurrency(plot.price)}</td>
                        <td>${plot.currentOwner}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td style="white-space: nowrap;">
                            <button onclick="editPlot(${plot.id})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">Edit</button>
                            <button onclick="openAddPaymentForPlot(${plot.id})" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">+ Payment</button>
                            <button onclick="deletePlot(${plot.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìä</div>No plots yet. Add your first plot!</td></tr>';
        }

        function renderPaymentsView() {
            const content = document.getElementById('mainContentArea');
            let allPayments = [];
            plots.forEach(plot => {
                (plot.payments || []).forEach(payment => {
                    allPayments.push({ ...payment, plotName: plot.name, plotNumber: plot.plotNumber, plotId: plot.id });
                });
            });
            allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

            content.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">All Payments</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Plot</th>
                                <th>Investor</th>
                                <th>Amount</th>
                                <th>Type</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPayments.map(payment => `
                                <tr>
                                    <td>${formatDate(payment.date)}</td>
                                    <td>${payment.plotNumber}</td>
                                    <td>${users[payment.investor].name}</td>
                                    <td><strong>${formatCurrency(payment.amount)}</strong></td>
                                    <td><span class="status-badge ${payment.type === 'investment' ? 'status-owned' : 'status-sold'}">
                                        ${payment.type === 'investment' ? 'Investment' : 'Return'}
                                    </span></td>
                                    <td>${payment.notes}</td>
                                    <td>
                                        <button onclick="editPayment(${payment.plotId}, ${payment.id})" class="btn btn-secondary" style="margin-right: 4px;">Edit</button>
                                        <button onclick="deletePayment(${payment.plotId}, ${payment.id})" class="btn btn-danger">Delete</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üí∞</div>No payments recorded yet.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderMyPlotsView() {
            const myPlots = plots.filter(p => (p.payments || []).some(pay => pay.investor === currentUser.id));
            const content = document.getElementById('mainContentArea');
            content.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">My Investments</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Plot</th>
                                <th>Status</th>
                                <th>My Investment</th>
                                <th>Returns Received</th>
                                <th>Profit/Loss</th>
                                <th>My Stake %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${myPlots.length ? myPlots.map(p => {
                                const myInvestments = p.payments.filter(pay => pay.investor === currentUser.id && pay.type === 'investment').reduce((sum, pay) => sum + pay.amount, 0);
                                const myReturns = p.payments.filter(pay => pay.investor === currentUser.id && pay.type === 'return').reduce((sum, pay) => sum + pay.amount, 0);
                                const myProfitLoss = myReturns - myInvestments;
                                const totalInvestment = p.payments.filter(pay => pay.type === 'investment').reduce((sum, pay) => sum + pay.amount, 0);
                                const myStake = totalInvestment > 0 ? ((myInvestments / totalInvestment) * 100).toFixed(1) : 0;
                                const profitLossColor = myProfitLoss > 0 ? '#10b981' : myProfitLoss < 0 ? '#ef4444' : '#6b7280';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong>${p.plotNumber}</strong><br>
                                            <span style="color: var(--text-light); font-size: 13px;">${p.name}</span>
                                        </td>
                                        <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                                        <td><strong>${formatCurrency(myInvestments)}</strong></td>
                                        <td><strong style="color: #10b981;">${formatCurrency(myReturns)}</strong></td>
                                        <td><strong style="color: ${profitLossColor};">${myProfitLoss >= 0 ? '+' : ''}${formatCurrency(myProfitLoss)}</strong></td>
                                        <td><span class="status-badge status-owned">${myStake}%</span></td>
                                    </tr>
                                `;
                            }).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìä</div>No investments yet. Check opportunities!</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderOpportunitiesView() {
            const opportunities = plots.filter(p => p.status === 'available');
            const content = document.getElementById('mainContentArea');
            content.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Investment Opportunities</h3>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Plot</th><th>Area</th><th>Price</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            ${opportunities.length ? opportunities.map(p => `
                                <tr>
                                    <td><strong>${p.plotNumber}</strong><br><span style="color: var(--text-light); font-size: 13px;">${p.name}</span></td>
                                    <td>${p.area} sq ft</td>
                                    <td><strong>${formatCurrency(p.price)}</strong></td>
                                    <td>${p.description || '-'}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" class="empty-state"><div class="empty-state-icon">üîç</div>No opportunities available.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderInvestorsView() {
            const content = document.getElementById('mainContentArea');
            const investorsList = investors.filter(inv => inv.role === 'investor');
            
            content.innerHTML = `
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Investor Management</h3>
                        <button class="btn btn-primary" onclick="openAddInvestor()">+ Add Investor</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Total Invested</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${investorsList.map(inv => {
                                const totalInvested = plots.reduce((sum, p) => 
                                    sum + (p.payments || [])
                                        .filter(pay => pay.investor === inv.id && pay.type === 'investment')
                                        .reduce((s, pay) => s + pay.amount, 0), 0);
                                
                                return `
                                    <tr>
                                        <td><strong>${inv.name}</strong></td>
                                        <td>${inv.username}</td>
                                        <td>${inv.email || '-'}</td>
                                        <td><code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">${inv.password}</code></td>
                                        <td><strong>${formatCurrency(totalInvested)}</strong></td>
                                        <td style="white-space: nowrap;">
                                            <button onclick="editInvestor('${inv.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">Edit</button>
                                            <button onclick="deleteInvestor('${inv.id}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('') || '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üë•</div>No investors yet.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function formatCurrency(amount) {
            return '‚Çπ' + (amount || 0).toLocaleString('en-IN');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openAddPlot() {
            document.getElementById('plotModalTitle').textContent = 'Add New Plot';
            document.getElementById('editPlotId').value = '';
            ['plotName', 'plotNumber', 'surveyNumber', 'plotArea', 'plotPrice', 'currentOwner', 'plotDescription', 'advancePaid'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('plotStatus').value = 'available';
            openModal('plotModal');
        }

        function editPlot(plotId) {
            const plot = plots.find(p => p.id === plotId);
            document.getElementById('plotModalTitle').textContent = 'Edit Plot';
            document.getElementById('editPlotId').value = plotId;
            document.getElementById('plotName').value = plot.name;
            document.getElementById('plotNumber').value = plot.plotNumber;
            document.getElementById('surveyNumber').value = plot.surveyNumber || '';
            document.getElementById('plotArea').value = plot.area;
            document.getElementById('plotPrice').value = plot.price;
            document.getElementById('currentOwner').value = plot.currentOwner || '';
            document.getElementById('plotStatus').value = plot.status;
            document.getElementById('advancePaid').value = plot.advancePaid || '';
            document.getElementById('plotDescription').value = plot.description || '';
            openModal('plotModal');
        }

        function savePlot() {
            const name = document.getElementById('plotName').value;
            const plotNumber = document.getElementById('plotNumber').value;
            const area = parseInt(document.getElementById('plotArea').value);
            const price = parseInt(document.getElementById('plotPrice').value);

            if (!name || !plotNumber || !area || !price) {
                alert('Please fill all required fields');
                return;
            }

            const editId = document.getElementById('editPlotId').value;
            
            if (editId) {
                const plot = plots.find(p => p.id === parseInt(editId));
                plot.name = name;
                plot.plotNumber = plotNumber;
                plot.surveyNumber = document.getElementById('surveyNumber').value;
                plot.area = area;
                plot.price = price;
                plot.currentOwner = document.getElementById('currentOwner').value || 'Available';
                plot.status = document.getElementById('plotStatus').value;
                plot.advancePaid = parseInt(document.getElementById('advancePaid').value) || 0;
                plot.description = document.getElementById('plotDescription').value;
                showSuccess('Plot updated!');
            } else {
                plots.push({
                    id: Math.max(0, ...plots.map(p => p.id)) + 1,
                    name, plotNumber,
                    surveyNumber: document.getElementById('surveyNumber').value,
                    area, price,
                    currentOwner: document.getElementById('currentOwner').value || 'Available',
                    status: document.getElementById('plotStatus').value,
                    advancePaid: parseInt(document.getElementById('advancePaid').value) || 0,
                    description: document.getElementById('plotDescription').value,
                    payments: []
                });
                showSuccess('Plot added!');
            }

            saveToLocalStorage();
            closeModal('plotModal');
            renderPlotsTable();
            renderStats();
        }

        function deletePlot(plotId) {
            if (confirm('Delete this plot and all payments?')) {
                plots = plots.filter(p => p.id !== plotId);
                saveToLocalStorage();
                renderPlotsTable();
                renderStats();
                showSuccess('Plot deleted!');
            }
        }

        function editPayment(plotId, paymentId) {
            const plot = plots.find(p => p.id === plotId);
            const payment = plot.payments.find(p => p.id === paymentId);
            document.getElementById('paymentModalTitle').textContent = 'Edit Payment';
            document.getElementById('editPaymentId').value = paymentId;
            document.getElementById('paymentPlotId').value = plotId;
            document.getElementById('paymentInvestor').value = payment.investor;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentType').value = payment.type;
            document.getElementById('paymentDate').value = payment.date;
            document.getElementById('paymentNotes').value = payment.notes || '';
            openModal('paymentModal');
        }

        function savePayment() {
            const plotId = parseInt(document.getElementById('paymentPlotId').value);
            const editId = document.getElementById('editPaymentId').value;
            const amount = parseInt(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;

            if (!amount || !date) {
                alert('Please fill required fields');
                return;
            }

            const plot = plots.find(p => p.id === plotId);
            if (!plot.payments) plot.payments = [];

            if (editId) {
                const payment = plot.payments.find(p => p.id === parseInt(editId));
                payment.investor = document.getElementById('paymentInvestor').value;
                payment.amount = amount;
                payment.type = document.getElementById('paymentType').value;
                payment.date = date;
                payment.notes = document.getElementById('paymentNotes').value;
                showSuccess('Payment updated!');
            } else {
                plot.payments.push({
                    id: Date.now(),
                    investor: document.getElementById('paymentInvestor').value,
                    amount: amount,
                    type: document.getElementById('paymentType').value,
                    date: date,
                    notes: document.getElementById('paymentNotes').value
                });
                showSuccess('Payment added!');
            }

            saveToLocalStorage();
            closeModal('paymentModal');
            if (currentView === 'payments') renderPaymentsView();
            renderStats();
        }

        function deletePayment(plotId, paymentId) {
            if (confirm('Delete this payment?')) {
                const plot = plots.find(p => p.id === plotId);
                plot.payments = plot.payments.filter(p => p.id !== paymentId);
                saveToLocalStorage();
                if (currentView === 'payments') renderPaymentsView();
                renderStats();
                showSuccess('Payment deleted!');
            }
        }

        function openAddPaymentForPlot(plotId) {
            document.getElementById('paymentModalTitle').textContent = 'Add Payment';
            document.getElementById('editPaymentId').value = '';
            document.getElementById('paymentPlotId').value = plotId;
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';
            document.getElementById('paymentDate').valueAsDate = new Date();
            document.getElementById('paymentType').value = 'investment';
            
            const plot = plots.find(p => p.id === plotId);
            const plotInfo = document.getElementById('plotInfo');
            if (plotInfo) {
                plotInfo.textContent = `Plot: ${plot.plotNumber} - ${plot.name}`;
            }
            
            // Populate investor dropdown
            populateInvestorDropdown();
            
            openModal('paymentModal');
        }

        function populateInvestorDropdown() {
            const select = document.getElementById('paymentInvestor');
            const investorsList = investors.filter(inv => inv.role === 'investor');
            select.innerHTML = investorsList.map(inv => 
                `<option value="${inv.id}">${inv.name}</option>`
            ).join('');
        }

        function openAddInvestor() {
            document.getElementById('investorModalTitle').textContent = 'Add Investor';
            document.getElementById('editInvestorId').value = '';
            document.getElementById('investorName').value = '';
            document.getElementById('investorUsername').value = '';
            document.getElementById('investorPassword').value = '';
            document.getElementById('investorEmail').value = '';
            openModal('investorModal');
        }

        function editInvestor(investorId) {
            const investor = investors.find(inv => inv.id === investorId);
            document.getElementById('investorModalTitle').textContent = 'Edit Investor';
            document.getElementById('editInvestorId').value = investorId;
            document.getElementById('investorName').value = investor.name;
            document.getElementById('investorUsername').value = investor.username;
            document.getElementById('investorPassword').value = investor.password;
            document.getElementById('investorEmail').value = investor.email || '';
            openModal('investorModal');
        }

        function saveInvestor() {
            const name = document.getElementById('investorName').value.trim();
            const username = document.getElementById('investorUsername').value.trim();
            const password = document.getElementById('investorPassword').value;
            const email = document.getElementById('investorEmail').value.trim();

            if (!name || !username || !password) {
                alert('Please fill all required fields (Name, Username, Password)');
                return;
            }

            const editId = document.getElementById('editInvestorId').value;
            
            // Check for duplicate username
            const duplicate = investors.find(inv => 
                inv.username === username && inv.id !== editId
            );
            
            if (duplicate) {
                alert('Username already exists. Please choose a different username.');
                return;
            }

            if (editId) {
                // Edit existing investor
                const investor = investors.find(inv => inv.id === editId);
                investor.name = name;
                investor.username = username;
                investor.password = password;
                investor.email = email;
                showSuccess('Investor updated!');
            } else {
                // Add new investor
                const newId = 'investor' + (investors.filter(i => i.role === 'investor').length + 1);
                investors.push({
                    id: newId,
                    name: name,
                    username: username,
                    password: password,
                    role: 'investor',
                    email: email
                });
                showSuccess('Investor added!');
            }

            buildUsersObject();
            saveInvestorsToLocalStorage();
            closeModal('investorModal');
            if (currentView === 'investors') renderInvestorsView();
        }

        function deleteInvestor(investorId) {
            // Check if investor has any investments
            const hasInvestments = plots.some(p => 
                (p.payments || []).some(pay => pay.investor === investorId)
            );

            if (hasInvestments) {
                alert('Cannot delete investor with existing investments. Please remove their payments first.');
                return;
            }

            if (confirm('Are you sure you want to delete this investor?')) {
                investors = investors.filter(inv => inv.id !== investorId);
                buildUsersObject();
                saveInvestorsToLocalStorage();
                renderInvestorsView();
                showSuccess('Investor deleted!');
            }
        }

        function saveInvestorsToLocalStorage() {
            localStorage.setItem('investorsData', JSON.stringify(investors));
        }

        function loadInvestorsFromLocalStorage() {
            const saved = localStorage.getItem('investorsData');
            if (saved) {
                investors = JSON.parse(saved);
                buildUsersObject();
            }
        }

        function changeAdminPassword() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            openModal('changePasswordModal');
        }

        function saveNewPassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;

            if (!currentPwd || !newPwd || !confirmPwd) {
                alert('Please fill all fields');
                return;
            }

            // Verify current password
            const admin = investors.find(inv => inv.id === 'admin');
            if (admin.password !== currentPwd) {
                alert('Current password is incorrect');
                return;
            }

            // Check if new passwords match
            if (newPwd !== confirmPwd) {
                alert('New passwords do not match');
                return;
            }

            // Check password strength (minimum 6 characters)
            if (newPwd.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            // Update password
            admin.password = newPwd;
            buildUsersObject();
            saveInvestorsToLocalStorage();
            
            closeModal('changePasswordModal');
            showSuccess('Admin password updated successfully! Remember to sync to save to Google Sheets.');
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
